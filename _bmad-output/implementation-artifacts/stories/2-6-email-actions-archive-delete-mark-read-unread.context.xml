<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>6</storyId>
    <title>Email Actions (Archive, Delete, Mark Read/Unread)</title>
    <status>drafted</status>
    <generatedAt>2025-12-05</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-6-email-actions-archive-delete-mark-read-unread.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to organize my emails with basic actions (archive, delete, mark read/unread)</iWant>
    <soThat>I can keep my inbox manageable and stay organized</soThat>
    <tasks>
      <task id="1" title="Create Email Actions Service">
        <subtask>1.1: Create EmailActionsService class with singleton pattern</subtask>
        <subtask>1.2: Implement archiveEmail(emailId) method</subtask>
        <subtask>1.3: Implement deleteEmail(emailId) method</subtask>
        <subtask>1.4: Implement toggleReadStatus(emailId) method</subtask>
        <subtask>1.5: Implement markAsRead(emailIds[]) bulk method</subtask>
        <subtask>1.6: Implement markAsUnread(emailIds[]) bulk method</subtask>
        <subtask>1.7: Add action logging for audit trail</subtask>
      </task>
      <task id="2" title="Implement Offline Action Queue">
        <subtask>2.1: Create ActionQueue RxDB schema</subtask>
        <subtask>2.2: Implement queueAction(action) method</subtask>
        <subtask>2.3: Implement processQueue() method</subtask>
        <subtask>2.4: Add retry logic with exponential backoff</subtask>
        <subtask>2.5: Handle network status detection</subtask>
      </task>
      <task id="3" title="Implement Optimistic UI Updates">
        <subtask>3.1: Implement optimistic update pattern in emailStore</subtask>
        <subtask>3.2: Add rollback capability for failed actions</subtask>
        <subtask>3.3: Update email list UI immediately on action</subtask>
        <subtask>3.4: Handle sync confirmation/rollback states</subtask>
        <subtask>3.5: Add loading states for in-progress actions</subtask>
      </task>
      <task id="4" title="Create Action UI Components">
        <subtask>4.1: Create EmailActionBar component</subtask>
        <subtask>4.2: Create EmailActionButton component</subtask>
        <subtask>4.3: Add icons using lucide-react</subtask>
        <subtask>4.4: Create BulkActionBar for multi-select</subtask>
        <subtask>4.5: Add confirmation dialog for delete</subtask>
      </task>
      <task id="5" title="Implement Email Selection">
        <subtask>5.1: Create selectionStore with Zustand</subtask>
        <subtask>5.2: Create useEmailSelection hook</subtask>
        <subtask>5.3: Implement single-click selection</subtask>
        <subtask>5.4: Implement Shift+click range selection</subtask>
        <subtask>5.5: Implement Ctrl/Cmd+click toggle selection</subtask>
        <subtask>5.6: Add Select All / Deselect All functionality</subtask>
      </task>
      <task id="6" title="Implement Keyboard Shortcuts">
        <subtask>6.1: Create useEmailKeyboardShortcuts hook</subtask>
        <subtask>6.2: Implement 'e' key for archive</subtask>
        <subtask>6.3: Implement '#' key for delete</subtask>
        <subtask>6.4: Implement 'u' key for toggle read/unread</subtask>
        <subtask>6.5: Ensure shortcuts don't fire in inputs</subtask>
        <subtask>6.6: Add shortcuts to help modal</subtask>
      </task>
      <task id="7" title="Implement Undo Toast">
        <subtask>7.1: Create undoStore with action history</subtask>
        <subtask>7.2: Create UndoToast component with countdown</subtask>
        <subtask>7.3: Implement 5-second undo window</subtask>
        <subtask>7.4: Create useUndoAction hook</subtask>
        <subtask>7.5: Handle undo for all action types</subtask>
        <subtask>7.6: Auto-dismiss toast after 5 seconds</subtask>
      </task>
      <task id="8" title="Integrate with Gmail API">
        <subtask>8.1: Implement Gmail API modify endpoint</subtask>
        <subtask>8.2: Map archive to label changes</subtask>
        <subtask>8.3: Map delete to TRASH</subtask>
        <subtask>8.4: Map read/unread to UNREAD label</subtask>
        <subtask>8.5: Handle batch operations</subtask>
        <subtask>8.6: Integrate with sync orchestrator</subtask>
      </task>
      <task id="9" title="Update Email List and Thread Views">
        <subtask>9.1: Add checkbox for multi-select</subtask>
        <subtask>9.2: Add action buttons to list item hover</subtask>
        <subtask>9.3: Add action bar to thread detail view</subtask>
        <subtask>9.4: Update read/unread visual styling</subtask>
        <subtask>9.5: Handle archived/deleted emails disappearing</subtask>
      </task>
      <task id="10" title="Testing">
        <subtask>10.1: Write unit tests for EmailActionsService</subtask>
        <subtask>10.2: Write unit tests for action queue</subtask>
        <subtask>10.3: Write unit tests for optimistic updates</subtask>
        <subtask>10.4: Write unit tests for useEmailSelection hook</subtask>
        <subtask>10.5: Write E2E test for archive flow</subtask>
        <subtask>10.6: Write E2E test for delete with undo flow</subtask>
        <subtask>10.7: Write E2E test for bulk actions</subtask>
        <subtask>10.8: Test offline action queueing and sync</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">Archive button removes email from inbox (moves to Archive folder)</criterion>
    <criterion id="AC2">Delete button moves email to Trash (soft delete)</criterion>
    <criterion id="AC3">Mark as read/unread toggles unread status</criterion>
    <criterion id="AC4">Keyboard shortcuts implemented (e for archive, # for delete, u for toggle read)</criterion>
    <criterion id="AC5">Bulk actions available (select multiple emails, apply action to all)</criterion>
    <criterion id="AC6">Undo option for destructive actions (5-second toast notification)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Functional Requirements FR007, FR032</section>
        <snippet>FR007: Maintain full read/write functionality when offline, queueing actions for later sync. FR032: Provide immediate visual feedback for offline actions with optimistic UI patterns.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Decision Document</title>
        <section>Decision 1: RxDB + IndexedDB, Decision 2: Zustand</section>
        <snippet>RxDB for offline-first reactive database. Zustand for global state management with TypeScript support, devtools enabled for debugging.</snippet>
      </doc>
      <doc>
        <path>docs/research/optimistic-ui-patterns-research.md</path>
        <title>Optimistic UI Patterns and Conflict Resolution</title>
        <section>Email Client Context, Gmail-style undo</section>
        <snippet>Recommended patterns: Use React 19 useOptimistic hook for simple actions. Combine React Query + RxDB for complex offline-first operations. Implement Gmail-style undo with 5-second snackbar for destructive actions.</snippet>
      </doc>
      <doc>
        <path>docs/research/keyboard-shortcuts-research.md</path>
        <title>Keyboard Shortcut Management Systems</title>
        <section>react-hotkeys-hook recommendation</section>
        <snippet>Recommend react-hotkeys-hook for keyboard shortcut management. Hook-based API aligns with React 19 patterns, built-in scope system for context-aware shortcuts, filter options to prevent conflicts with form fields.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>src/services/database/schemas/email.schema.ts</path>
        <kind>schema</kind>
        <symbol>EmailDocument, emailSchema</symbol>
        <lines>1-376</lines>
        <reason>Email schema defines folder, read, labels fields that actions will modify. Key fields: folder (string), read (boolean), labels (string[])</reason>
      </file>
      <file>
        <path>src/services/email/sendQueueService.ts</path>
        <kind>service</kind>
        <symbol>SendQueueService</symbol>
        <lines>1-100</lines>
        <reason>Reference implementation for offline queue pattern with retry logic. Use similar singleton pattern, event emitter, and exponential backoff approach for action queue.</reason>
      </file>
      <file>
        <path>src/services/search/searchIndexService.ts</path>
        <kind>service</kind>
        <symbol>SearchIndexService</symbol>
        <reason>Reference for singleton service pattern with getInstance(), logger integration, and __resetForTesting() method. Follow same pattern for EmailActionsService.</reason>
      </file>
      <file>
        <path>src/services/database/init.ts</path>
        <kind>service</kind>
        <symbol>getDatabase</symbol>
        <reason>Database access function used across services. Import with: import { getDatabase } from '@/services/database/init'</reason>
      </file>
      <file>
        <path>src/services/logger/index.ts</path>
        <kind>service</kind>
        <symbol>logger</symbol>
        <reason>Logging service for action audit trail. Import with: import { logger } from '@/services/logger'</reason>
      </file>
      <file>
        <path>src/store/searchStore.ts</path>
        <kind>store</kind>
        <symbol>useSearchStore</symbol>
        <reason>Reference for Zustand store pattern. Follow same structure for selectionStore and undoStore.</reason>
      </file>
      <file>
        <path>src/App.tsx</path>
        <kind>component</kind>
        <symbol>App</symbol>
        <reason>Contains global keyboard shortcuts pattern for / and Cmd+K. Extend for e, #, u shortcuts.</reason>
      </file>
      <file>
        <path>src/components/email/EmailListItem.tsx</path>
        <kind>component</kind>
        <symbol>EmailListItem</symbol>
        <reason>Email list item component to update with checkbox and hover action buttons.</reason>
      </file>
    </code>
    <dependencies>
      <node>
        <package>rxdb</package>
        <version>16.20.0</version>
        <purpose>Offline-first reactive database for local state</purpose>
      </node>
      <package>zustand</package>
        <version>5.0.8</version>
        <purpose>State management for selection, undo stores</purpose>
      </package>
      <package>lucide-react</package>
        <version>0.552.0</version>
        <purpose>Icons for action buttons (Archive, Trash, Mail, MailOpen)</purpose>
      </package>
      <package>rxjs</package>
        <version>7.8.2</version>
        <purpose>Observables for action queue events</purpose>
      </package>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">Use singleton pattern with getInstance() for services (per SearchIndexService)</constraint>
    <constraint type="pattern">Use Zustand for UI state stores (per architecture decision 2)</constraint>
    <constraint type="pattern">Use RxDB for persistent data with reactive queries</constraint>
    <constraint type="performance">Actions must complete in &lt;50ms (NFR001)</constraint>
    <constraint type="offline">All actions must work offline, queue for sync when online (FR007)</constraint>
    <constraint type="undo">Undo window is exactly 5 seconds per PRD FR022</constraint>
    <constraint type="testing">Unit tests required for services and hooks (>80% coverage)</constraint>
    <constraint type="testing">E2E tests required for user flows</constraint>
    <constraint type="accessibility">Keyboard shortcuts must not conflict with form inputs</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>EmailActionsService</name>
      <kind>class interface</kind>
      <signature>
class EmailActionsService {
  static getInstance(): EmailActionsService
  archiveEmail(emailId: string): Promise&lt;void&gt;
  deleteEmail(emailId: string): Promise&lt;void&gt;
  toggleReadStatus(emailId: string): Promise&lt;void&gt;
  markAsRead(emailIds: string[]): Promise&lt;void&gt;
  markAsUnread(emailIds: string[]): Promise&lt;void&gt;
}
      </signature>
      <path>src/services/email/emailActionsService.ts</path>
    </interface>
    <interface>
      <name>Gmail API Modify</name>
      <kind>REST endpoint</kind>
      <signature>POST /gmail/v1/users/{userId}/messages/{id}/modify
Body: { addLabelIds?: string[], removeLabelIds?: string[] }
POST /gmail/v1/users/{userId}/messages/{id}/trash</signature>
      <path>External Gmail API</path>
    </interface>
    <interface>
      <name>SelectionStore</name>
      <kind>Zustand store</kind>
      <signature>
interface SelectionStore {
  selectedIds: Set&lt;string&gt;
  selectMode: boolean
  setSelectedIds: (ids: Set&lt;string&gt;) => void
  toggleSelect: (id: string) => void
  selectRange: (startId: string, endId: string) => void
  selectAll: () => void
  clearSelection: () => void
}
      </signature>
      <path>src/store/selectionStore.ts</path>
    </interface>
    <interface>
      <name>UndoStore</name>
      <kind>Zustand store</kind>
      <signature>
interface UndoStore {
  pendingActions: UndoableAction[]
  addAction: (action: UndoableAction) => void
  undoAction: (actionId: string) => Promise&lt;void&gt;
  removeAction: (actionId: string) => void
}
      </signature>
      <path>src/store/undoStore.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
Testing uses Vitest 4.0 for unit tests and Playwright 1.56 for E2E tests. Unit tests follow AAA pattern (Arrange, Act, Assert). Mock logger, database, and network calls. Use fake-indexeddb for RxDB tests. E2E tests should test complete user flows including offline scenarios. Target >80% coverage for new services and hooks.
    </standards>
    <locations>
      <location>src/services/email/__tests__/</location>
      <location>src/hooks/__tests__/</location>
      <location>src/store/__tests__/</location>
      <location>e2e/</location>
    </locations>
    <ideas>
      <idea ac="AC1">Test archiveEmail updates folder to 'ARCHIVE' and removes 'INBOX' from labels locally</idea>
      <idea ac="AC1">Test archive action is queued when offline and synced when online</idea>
      <idea ac="AC2">Test deleteEmail moves email to TRASH folder</idea>
      <idea ac="AC2">Test Gmail API trash endpoint is called on sync</idea>
      <idea ac="AC3">Test toggleReadStatus flips read boolean and updates labels</idea>
      <idea ac="AC4">Test e key triggers archive on focused email, not in input fields</idea>
      <idea ac="AC4">Test # key triggers delete with confirmation</idea>
      <idea ac="AC4">Test u key toggles read/unread status</idea>
      <idea ac="AC5">Test selecting multiple emails with Shift+click and Cmd+click</idea>
      <idea ac="AC5">Test bulk archive/delete applies to all selected emails</idea>
      <idea ac="AC6">Test undo toast appears after destructive action</idea>
      <idea ac="AC6">Test clicking undo reverts email to previous state</idea>
      <idea ac="AC6">Test toast auto-dismisses after 5 seconds</idea>
      <idea>E2E: Complete archive flow from selection to Gmail API call</idea>
      <idea>E2E: Delete with undo - delete email, undo, verify restored</idea>
      <idea>E2E: Offline mode - queue actions, go online, verify sync</idea>
    </ideas>
  </tests>
</story-context>
